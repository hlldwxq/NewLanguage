#!/bin/bash

set -e  # Terminate on errors

LLVMIR=./llvmir
LLVMAS=llvm-as-10
CLANG=clang++-10

function fail() {
  echo "ERROR: $BASENAME ($CFGNAME): $1"
  echo "Logfile: $LOGFILE"
  exit 1
}

# prepare <qfile>, expects $FLAGS, $CFGNAME to be set
function prepare() {
  QFILE="$1"

  BASENAME="${QFILE%.q}"
  STEM=${BASENAME##*/}
  DIRNAME="${BASENAME%/*}"

  OUTDIR=$DIRNAME/out
  OUTBASE=$OUTDIR/$STEM.$CFGNAME
  mkdir -p "$OUTDIR"

  JAVAC="javac -d $OUTDIR"
  JAVA="java -cp $OUTDIR"

  # Input files
  # QFILE
  JAVAFILE="$BASENAME.java"
  CFILE="$BASENAME.cpp"

  # Output files
  LLFILE="$OUTBASE.ll"
  OUTFILE="$LLFILE.out"
  CLASSFILE=${BASENAME##*/}  
 
  LOGFILE="$OUTBASE.log"

  SFILE="$OUTBASE.opt.ll"
  OUTOPTFILE="$SFILE.out"

  Q="q"

  JAVASIGN="Java time"
  QSIGN="q time"
  QOPTSIGN="q opt time"

  #rm -rf $LLFILE $OUTFILE $LOGFILE

  echo -n "Testing $BASENAME ($CFGNAME), flags $FLAGS: "
  echo ""
}

function run(){

    # do test first
    #: > "$LOGFILE"

    echo "$BASENAME $CFGNAME test"
    ./"$OUTFILE">/dev/null

    echo "$BASENAME $CFGNAME run java code"
    echo "$JAVASIGN">>"$LOGFILE"
    for i in $(seq 1 5) 
    do
         $JAVA "$CLASSFILE" | tee -a "$LOGFILE"
    done

    echo "$BASENAME $CFGNAME run not opt q code"
    echo "$QSIGN">>"$LOGFILE"
    for i in $(seq 1 5) 
    do
       ./"$OUTFILE" "$Q" | tee -a "$LOGFILE"
    done

    echo "$BASENAME $CFGNAME run opt q code"
    echo "$QOPTSIGN">>"$LOGFILE"
    for i in $(seq 1 5) 
    do
        ./"$OUTOPTFILE" "$Q"  | tee -a "$LOGFILE"
    done

}

function compile() {
  $LLVMIR $FLAGS $QFILE > $LLFILE 2>$LOGFILE || fail "Compilation error"

  $LLVMAS -disable-output $LLFILE 1>$LOGFILE 2>&1 || fail "Invalid llvm text generated by compiler"
  $CLANG -O2 -o "$OUTFILE" "$CFILE" "$LLFILE" 1>$LOGFILE 2>&1 || fail "Clang compilation error"

  # Peter's proposal: just -O3
  # $CLANG -O3 -o "$OUTOPTFILE" "$CFILE" "$LLFILE" 1>$LOGOPTFILE 2>&1 || fail "Clang compilation error"

  # Qiao's original opt test
  opt-10 -S -O3 "$LLFILE">"$SFILE"
  $CLANG -O2 -o "$OUTOPTFILE" "$CFILE" "$SFILE" 1>$LOGFILE 2>&1 || fail "Clang opt compilation error"

  # compile java
  $JAVAC "$JAVAFILE"

}

function do_test() {
  prepare $1
  compile
  run
}

function do_tests() {
  if [ $# -eq 2 ];
  then
      FLAGS=$1
      CFGNAME=$2
  elif [ $# -eq 3 ];
  then
      FLAGS="$1 $2"
      CFGNAME=$3
  else
      FLAGS="$1 $2 $3"
      CFGNAME=$4
  fi

#  do_test tests/betchmark/unique.q

  for i in tests/benchmark/Java/*.q; do
    do_test $i
  done

}

do_tests DyCheck dy
do_tests notDyCheck ndy

#do_tests check_arith arith
#do_tests check_array_bound array
#do_tests check_free free

#do_tests check_arith check_array_bound arith_array
#do_tests check_free	check_array_bound free_array
#do_tests check_free	check_arith free_arith

#do_tests check_arith check_free	check_array_bound arith_array_free
